<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MN Fun Squad — Hall of Fame Bracket</title>
  <style>
    /* ── Reset & Base ──────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --surface2: #22253a;
      --border: #2e3345;
      --accent: #6c63ff;
      --accent-glow: rgba(108, 99, 255, .35);
      --win: #00c896;
      --danger: #e5484d;
      --text: #e2e4ed;
      --muted: #7a7f96;
      --round-gap: 28px;
      --slot-h: 34px;
      --slot-gap: 4px;
      --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    html { scroll-behavior: smooth; }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: auto;
    }

    /* ── Header ────────────────────────────────────────────── */
    header {
      position: sticky; top: 0; z-index: 100;
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 28px;
      background: linear-gradient(180deg, var(--surface) 80%, transparent);
      backdrop-filter: blur(12px);
    }
    header h1 { font-size: 1.25rem; letter-spacing: .02em; }
    header h1 span { color: var(--accent); }

    .header-actions { display: flex; gap: 10px; }

    button {
      font-family: var(--font);
      font-size: .82rem;
      padding: 7px 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      transition: background .15s, border-color .15s, box-shadow .15s;
    }
    button:hover {
      border-color: var(--accent);
      box-shadow: 0 0 8px var(--accent-glow);
    }
    button.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
      font-weight: 600;
    }
    button.primary:hover { box-shadow: 0 0 14px var(--accent-glow); }
    button.danger {
      background: transparent;
      border-color: var(--danger);
      color: var(--danger);
    }
    button.danger:hover {
      background: rgba(229, 72, 77, .1);
      box-shadow: 0 0 8px rgba(229, 72, 77, .3);
    }
    button:disabled {
      opacity: .4;
      cursor: not-allowed;
      box-shadow: none !important;
    }

    /* ── Tabs ──────────────────────────────────────────────── */
    .tab-bar {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
      padding: 0 28px;
      background: var(--surface);
    }
    .tab-btn {
      padding: 12px 24px;
      font-size: .85rem;
      font-weight: 600;
      border: none;
      border-bottom: 2px solid transparent;
      border-radius: 0;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      transition: color .15s, border-color .15s;
    }
    .tab-btn:hover { color: var(--text); box-shadow: none; }
    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* ── Input Athletes Panel ──────────────────────────────── */
    #panel-athletes {
      max-width: 720px;
      margin: 0 auto;
      padding: 32px 28px 48px;
    }
    .athletes-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .athletes-header h2 { font-size: 1.15rem; }
    .athletes-count {
      font-size: .8rem;
      color: var(--muted);
      background: var(--surface2);
      padding: 4px 12px;
      border-radius: 20px;
    }

    .add-athlete-row {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
    }
    .add-athlete-row input {
      flex: 1;
      padding: 10px 14px;
      font-family: var(--font);
      font-size: .88rem;
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      outline: none;
      transition: border-color .15s, box-shadow .15s;
    }
    .add-athlete-row input::placeholder { color: var(--muted); }
    .add-athlete-row input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .athletes-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 28px;
    }
    .athlete-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      transition: border-color .12s, background .12s;
    }
    .athlete-item:hover {
      border-color: var(--accent);
      background: var(--surface2);
    }
    .athlete-number {
      min-width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--accent);
      color: #fff;
      font-size: .72rem;
      font-weight: 700;
      border-radius: 50%;
    }
    .athlete-name {
      flex: 1;
      font-size: .9rem;
      font-weight: 500;
    }
    .athlete-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }
    .athlete-remove {
      width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      border: 1px solid transparent;
      border-radius: 6px;
      background: transparent;
      color: var(--muted);
      font-size: 1.1rem;
      cursor: pointer;
      padding: 0;
      transition: color .12s, background .12s, border-color .12s;
    }
    .athlete-remove:hover {
      color: var(--danger);
      background: rgba(229, 72, 77, .1);
      border-color: var(--danger);
      box-shadow: none;
    }

    .athletes-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .athletes-actions .hint {
      font-size: .78rem;
      color: var(--muted);
      margin-left: auto;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    .empty-state .icon { font-size: 2.4rem; margin-bottom: 8px; }
    .empty-state p { font-size: .88rem; }

    /* ── Bracket Container ─────────────────────────────────── */
    #bracket-container {
      display: flex;
      align-items: flex-start;
      gap: var(--round-gap);
      padding: 28px 32px 48px;
      min-width: max-content;
    }

    .round {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0;
      min-width: 170px;
    }
    .round-label {
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: var(--muted);
      margin-bottom: 12px;
      white-space: nowrap;
    }

    .matchups {
      display: flex;
      flex-direction: column;
      gap: 0;
      width: 100%;
    }

    /* ── Matchup ───────────────────────────────────────────── */
    .matchup {
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .team-slot {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: space-between;
      height: var(--slot-h);
      padding: 0 10px;
      border: 1px solid var(--border);
      background: var(--surface);
      font-size: .78rem;
      cursor: pointer;
      user-select: none;
      transition: background .12s, border-color .12s, transform .1s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .team-slot .slot-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .team-slot .sport-badge {
      margin-left: auto;
      font-size: .58rem;
      padding: 1px 6px;
    }
    .team-slot:first-child { border-radius: 6px 6px 0 0; }
    .team-slot:last-child  { border-radius: 0 0 6px 6px; border-top: none; }

    .team-slot:hover:not(.empty):not(.winner) {
      border-color: var(--accent);
      background: rgba(108, 99, 255, .08);
      transform: scale(1.02);
      z-index: 2;
    }

    .team-slot.winner {
      background: rgba(0, 200, 150, .1);
      border-color: var(--win);
      color: var(--win);
      font-weight: 600;
    }
    .team-slot.loser { opacity: .38; }
    .team-slot.empty {
      cursor: default;
      color: var(--muted);
      font-style: italic;
    }

    .seed {
      display: inline-block;
      min-width: 20px;
      text-align: right;
      font-size: .68rem;
      color: var(--muted);
      font-weight: 600;
    }

    .round .matchup { margin-bottom: var(--slot-gap); }

    /* ── Sport Badges ─────────────────────────────────────── */
    .sport-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: .62rem;
      font-weight: 700;
      letter-spacing: .04em;
      text-transform: uppercase;
      background: var(--surface2);
      color: var(--text);
      border: 1px solid transparent;
      white-space: nowrap;
    }
    .sport-baseball { background: rgba(231, 76, 60, .18); color: #e74c3c; border-color: rgba(231, 76, 60, .5); }
    .sport-basketball { background: rgba(230, 126, 34, .18); color: #e67e22; border-color: rgba(230, 126, 34, .5); }
    .sport-football { background: rgba(46, 204, 113, .18); color: #2ecc71; border-color: rgba(46, 204, 113, .5); }
    .sport-hockey { background: rgba(52, 152, 219, .18); color: #3498db; border-color: rgba(52, 152, 219, .5); }
    .sport-soccer { background: rgba(155, 89, 182, .18); color: #9b59b6; border-color: rgba(155, 89, 182, .5); }
    .sport-other { background: rgba(241, 196, 15, .18); color: #f1c40f; border-color: rgba(241, 196, 15, .5); }

    /* ── Champion Banner ───────────────────────────────────── */
    #champion-banner {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px 40px;
      text-align: center;
    }
    #champion-banner.visible { display: flex; }
    #champion-banner .trophy { font-size: 2.6rem; margin-bottom: 6px; }
    #champion-banner .label  { font-size: .72rem; text-transform: uppercase; letter-spacing: .14em; color: var(--muted); }
    #champion-banner .name   { font-size: 1.5rem; font-weight: 700; color: var(--win); margin-top: 4px; }

    /* ── Toast ──────────────────────────────────────────────── */
    #toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      padding: 10px 22px; border-radius: 8px;
      background: var(--accent); color: #fff; font-size: .82rem; font-weight: 600;
      opacity: 0; pointer-events: none; transition: opacity .3s;
      z-index: 200;
    }
    #toast.show { opacity: 1; }

    /* ── Responsive ────────────────────────────────────────── */
    @media (max-width: 900px) {
      :root { --slot-h: 30px; }
      .round { min-width: 140px; }
      header { padding: 10px 16px; }
      .tab-bar { padding: 0 16px; }
      #panel-athletes { padding: 20px 16px 40px; }
      #bracket-container { padding: 16px; gap: 18px; }
      .add-athlete-row { flex-direction: column; }
    }
  </style>
</head>
<body>

<!-- Header -->
<header>
  <h1><span>MN Fun Squad</span> — Hall of Fame Bracket</h1>
  <div class="header-actions">
    <button id="btn-share">Share Bracket</button>
    <button id="btn-export-json" class="primary">Export Picks (JSON)</button>
    <button id="btn-export-pdf" class="primary">Export PDF</button>
  </div>
</header>

<!-- Tab Bar -->
<div class="tab-bar">
  <button class="tab-btn active" data-tab="athletes">Input Athletes</button>
  <button class="tab-btn" data-tab="bracket">Bracket</button>
</div>

<!-- ═══ TAB 1: Input Athletes ═══ -->
<div id="panel-athletes" class="tab-panel active">
  <div class="athletes-header">
    <h2>Athletes Roster</h2>
    <div class="athletes-count" id="athlete-count">0 / 64</div>
  </div>

  <div class="add-athlete-row">
    <input type="text" id="athlete-input" placeholder="Enter athlete name..." maxlength="60" autocomplete="off" />
    <button class="primary" id="btn-add-athlete">Add</button>
  </div>

  <ul class="athletes-list" id="athletes-list"></ul>

  <div class="athletes-actions">
    <button class="danger" id="btn-clear-all">Clear All</button>
    <button id="btn-resume-bracket" style="display:none;">Resume Bracket &rarr;</button>
    <button id="btn-generate-bracket" class="primary">Generate Bracket &rarr;</button>
    <span class="hint">Min 2 athletes needed to build a bracket</span>
  </div>
</div>

<!-- ═══ TAB 2: Bracket ═══ -->
<div id="panel-bracket" class="tab-panel">
  <div style="padding: 12px 28px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
    <button id="btn-randomize">Shuffle &amp; Reset</button>
    <button id="btn-reset-picks">Reset Picks</button>
    <button id="btn-share-bracket" class="primary">Share Bracket</button>
    <span style="font-size: .78rem; color: var(--muted); margin-left: auto;">Click a team to pick the winner. Click a winner to undo.</span>
  </div>
  <div id="bracket-container"></div>
  <div id="champion-banner">
    <div class="trophy">&#127942;</div>
    <div class="label">Champion</div>
    <div class="name" id="champion-name"></div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script type="module">
/* ════════════════════════════════════════════════════════════
   MN FUN SQUAD — HALL OF FAME BRACKET
   ════════════════════════════════════════════════════════════ */

import {
  nextPow2 as logicNextPow2,
  buildRounds,
  autoAdvanceByes as logicAutoAdvanceByes,
  applyPick,
  clearFromRound as logicClearFromRound,
  resetPicks as logicResetPicks,
} from './src/bracket-logic.js';

/* ── Tabs ──────────────────────────────────────────────── */
const tabBtns = document.querySelectorAll('.tab-btn');
tabBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    tabBtns.forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(`panel-${btn.dataset.tab}`).classList.add('active');
  });
});

function switchToTab(name) {
  tabBtns.forEach(b => {
    b.classList.toggle('active', b.dataset.tab === name);
  });
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById(`panel-${name}`).classList.add('active');
}

/* ── Athletes State ────────────────────────────────────── */
let athletes = [];

/* ── Sport Mapping ─────────────────────────────────────── */
const SPORT_MAP = {
  baseball: [
    'Babe Ruth', 'Jackie Robinson', 'Willie Mays', 'Hank Aaron', 'Barry Bonds',
    'Ken Griffey Jr.', 'Derek Jeter', 'Mike Trout', 'Shohei Ohtani',
    'Kirby Puckett', 'Wade Boggs', 'David Wells', 'Nolan Ryan', 'Cal Ripken Jr.',
    'Mariano Rivera', 'Pedro Martinez', 'Roger Clemens', 'Mike Piazza',
    'Albert Pujols', 'Ichiro Suzuki', 'Aaron Judge', 'Keith Hernandez'
  ],
  basketball: [
    'Michael Jordan', 'LeBron James', 'Kobe Bryant', 'Magic Johnson', 'Larry Bird',
    "Shaquille O'Neal", 'Tim Duncan', 'Stephen Curry', 'Kevin Durant',
    'Giannis Antetokounmpo', 'Mugsy Bogues', 'Bo Jackson'
  ],
  football: [
    'Tom Brady', 'Jerry Rice', 'Peyton Manning', 'Joe Montana', 'Walter Payton',
    'Barry Sanders', 'Lawrence Taylor', 'Deion Sanders'
  ],
  hockey: ['Wayne Gretzky', 'Mario Lemieux', 'Bobby Orr', 'Connor McDavid'],
  soccer: ['Pelé', 'Diego Maradona', 'Lionel Messi', 'Cristiano Ronaldo', 'Zinedine Zidane', 'Ronaldinho'],
  other: [
    'Tiger Woods', 'Jack Nicklaus', 'Serena Williams', 'Roger Federer',
    'Rafael Nadal', 'Novak Djokovic', 'Usain Bolt', 'Michael Phelps',
    'Muhammad Ali', 'Mike Tyson', 'Floyd Mayweather Jr.', 'Simone Biles'
  ]
};

const SPORT_LABELS = {
  baseball: 'Baseball',
  basketball: 'Basketball',
  football: 'Football',
  hockey: 'Hockey',
  soccer: 'Soccer',
  other: 'Other'
};

function getSport(name) {
  for (const [sport, list] of Object.entries(SPORT_MAP)) {
    if (list.includes(name)) return sport;
  }
  return 'other';
}

function renderAthletesList() {
  const list = document.getElementById('athletes-list');
  const countEl = document.getElementById('athlete-count');
  const genBtn = document.getElementById('btn-generate-bracket');
  const resumeBtn = document.getElementById('btn-resume-bracket');
  list.innerHTML = '';
  countEl.textContent = `${athletes.length} / 64`;
  genBtn.disabled = athletes.length < 2;

  // Show resume button if a bracket is saved
  const hasSaved = localStorage.getItem('mnfs_bracket') !== null;
  resumeBtn.style.display = hasSaved ? '' : 'none';

  if (athletes.length === 0) {
    list.innerHTML = `
      <div class="empty-state">
        <div class="icon">&#9917;</div>
        <p>No athletes added yet. Type a name above and click <strong>Add</strong>.</p>
      </div>`;
    return;
  }

  athletes.forEach((name, i) => {
    const li = document.createElement('li');
    li.className = 'athlete-item';
    li.innerHTML = `
      <div class="athlete-number">${i + 1}</div>
      <div class="athlete-name">${escapeHtml(name)}</div>
      <div class="athlete-meta"></div>`;
    const removeBtn = document.createElement('button');
    removeBtn.className = 'athlete-remove';
    removeBtn.title = 'Remove';
    removeBtn.innerHTML = '&times;';
    removeBtn.addEventListener('click', () => {
      athletes.splice(i, 1);
      saveAthletes();
      renderAthletesList();
    });
    const meta = li.querySelector('.athlete-meta');
    const sport = getSport(name);
    const badge = document.createElement('span');
    badge.className = `sport-badge sport-${sport}`;
    badge.textContent = SPORT_LABELS[sport] || 'Other';
    meta.appendChild(badge);
    meta.appendChild(removeBtn);
    list.appendChild(li);
  });
}

function addAthlete(name) {
  const trimmed = name.trim();
  if (!trimmed) return false;
  if (athletes.length >= 64) { toast('Maximum 64 athletes!'); return false; }
  if (athletes.some(a => a.toLowerCase() === trimmed.toLowerCase())) {
    toast('Athlete already in the list!');
    return false;
  }
  athletes.push(trimmed);
  saveAthletes();
  renderAthletesList();
  return true;
}

function escapeHtml(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

/* ── Persist athletes to localStorage ──────────────────── */
const ROSTER_VERSION = '2';   // bump when teams.json changes to force reload
function saveAthletes() {
  localStorage.setItem('mnfs_athletes', JSON.stringify(athletes));
  localStorage.setItem('mnfs_roster_v', ROSTER_VERSION);
}
function loadAthletes() {
  if (localStorage.getItem('mnfs_roster_v') !== ROSTER_VERSION) return false;
  const saved = localStorage.getItem('mnfs_athletes');
  if (saved) {
    try { athletes = JSON.parse(saved); return true; }
    catch { /* fall through */ }
  }
  return false;
}

/* ── Persist bracket state to localStorage ─────────────── */
function saveBracket() {
  const state = { currentTeams, rounds, roundNames };
  localStorage.setItem('mnfs_bracket', JSON.stringify(state));
}
function loadBracket() {
  const saved = localStorage.getItem('mnfs_bracket');
  if (!saved) return false;
  try {
    const state = JSON.parse(saved);
    if (!state.rounds || !state.rounds.length) return false;
    currentTeams = state.currentTeams || [];
    rounds = state.rounds;
    roundNames = state.roundNames || [];
    return true;
  } catch { return false; }
}
function clearSavedBracket() {
  localStorage.removeItem('mnfs_bracket');
}

/* ════════════════════════════════════════════════════════════
   SHARE BRACKET VIA URL
   ════════════════════════════════════════════════════════════
   Encodes the full bracket state into a compressed base64 URL
   parameter so users can share their picks with a link.
   ─────────────────────────────────────────────────────────── */

function bracketToShareData() {
  return { currentTeams, rounds, roundNames };
}

function compressJSON(obj) {
  const json = JSON.stringify(obj);
  // Use TextEncoder to get bytes, then deflate-compress, then base64url
  const bytes = new TextEncoder().encode(json);
  // Simple: use built-in CompressionStream if available, else fall back to raw base64
  if (typeof CompressionStream !== 'undefined') {
    const cs = new CompressionStream('deflate');
    const writer = cs.writable.getWriter();
    writer.write(bytes);
    writer.close();
    return new Response(cs.readable).arrayBuffer().then(buf => {
      return btoa(String.fromCharCode(...new Uint8Array(buf)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    });
  }
  // Fallback: raw base64url (larger but universally supported)
  return Promise.resolve(
    btoa(String.fromCharCode(...bytes))
      .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '')
  );
}

function decompressJSON(b64url) {
  const b64 = b64url.replace(/-/g, '+').replace(/_/g, '/');
  const padded = b64 + '=='.slice(0, (4 - b64.length % 4) % 4);
  const binary = atob(padded);
  const bytes = Uint8Array.from(binary, c => c.charCodeAt(0));

  if (typeof DecompressionStream !== 'undefined') {
    const ds = new DecompressionStream('deflate');
    const writer = ds.writable.getWriter();
    writer.write(bytes);
    writer.close();
    return new Response(ds.readable).text().then(JSON.parse);
  }
  // Fallback: raw base64
  return Promise.resolve(JSON.parse(new TextDecoder().decode(bytes)));
}

async function shareBracket() {
  if (!rounds.length) { toast('Generate a bracket first!'); return; }
  try {
    const data = bracketToShareData();
    const compressed = await compressJSON(data);
    const url = `${location.origin}${location.pathname}?b=${compressed}`;

    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(url);
      toast('Share link copied to clipboard!');
    } else {
      // Fallback: prompt
      prompt('Copy this share link:', url);
    }
  } catch (e) {
    console.error('Share error:', e);
    toast('Could not generate share link');
  }
}

async function loadFromURL() {
  const params = new URLSearchParams(location.search);
  const b = params.get('b');
  if (!b) return false;
  try {
    const data = await decompressJSON(b);
    if (!data.rounds || !data.rounds.length) return false;
    currentTeams = data.currentTeams || [];
    rounds = data.rounds;
    roundNames = data.roundNames || [];
    // Also populate athletes list from the shared teams (filter out BYEs)
    athletes = currentTeams.filter(t => !t.startsWith('BYE'));
    saveAthletes();
    saveBracket();
    // Clean the URL without reloading
    history.replaceState(null, '', location.pathname);
    return true;
  } catch (e) {
    console.error('Failed to load shared bracket:', e);
    return false;
  }
}

/* ── Add athlete UI wiring ─────────────────────────────── */
const athleteInput = document.getElementById('athlete-input');
document.getElementById('btn-add-athlete').addEventListener('click', () => {
  if (addAthlete(athleteInput.value)) {
    athleteInput.value = '';
    athleteInput.focus();
    toast('Athlete added!');
  }
});
athleteInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    if (addAthlete(athleteInput.value)) {
      athleteInput.value = '';
      toast('Athlete added!');
    }
  }
});

document.getElementById('btn-clear-all').addEventListener('click', () => {
  if (athletes.length === 0) return;
  if (confirm('Remove all athletes from the list?')) {
    athletes = [];
    saveAthletes();
    renderAthletesList();
    toast('All athletes cleared');
  }
});

document.getElementById('btn-generate-bracket').addEventListener('click', () => {
  if (athletes.length < 2) { toast('Need at least 2 athletes!'); return; }
  initBracket([...athletes]);
  switchToTab('bracket');
  toast(`Bracket generated with ${athletes.length} athletes!`);
});

document.getElementById('btn-resume-bracket').addEventListener('click', () => {
  if (loadBracket()) {
    renderBracket();
    updateChampionBanner();
    switchToTab('bracket');
    toast('Bracket resumed!');
  } else {
    toast('No saved bracket found');
  }
});

/* ════════════════════════════════════════════════════════════
   BRACKET ENGINE
   ════════════════════════════════════════════════════════════ */

const ROUND_NAMES_MAP = {
  64: ['Round of 64', 'Round of 32', 'Sweet 16', 'Elite 8', 'Final Four', 'Championship'],
  32: ['Round of 32', 'Sweet 16', 'Elite 8', 'Final Four', 'Championship'],
  16: ['Sweet 16', 'Elite 8', 'Final Four', 'Championship'],
  8:  ['Elite 8', 'Final Four', 'Championship'],
  4:  ['Final Four', 'Championship'],
  2:  ['Championship'],
};

let currentTeams = [];
let rounds = [];
let roundNames = [];

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toast._timer);
  toast._timer = setTimeout(() => el.classList.remove('show'), 2200);
}

/* ── Find next power of 2 ─────────────────────────────── */
function nextPow2(n) {
  let p = 2;
  while (p < n) p *= 2;
  return Math.min(p, 64);
}

/* ── Build bracket ─────────────────────────────────────── */
function initBracket(teams) {
  const built = buildRounds(teams, { shuffleTeams: true });
  currentTeams = built.currentTeams;
  rounds = built.rounds;
  roundNames = built.roundNames;

  logicAutoAdvanceByes(rounds);
  saveBracket();
  renderBracket();
  document.getElementById('champion-banner').classList.remove('visible');
  document.getElementById('champion-name').textContent = '';
}

function autoAdvanceByes() {
  logicAutoAdvanceByes(rounds);
}

/* ── Reset picks (keep seeding) ────────────────────────── */
function resetPicks() {
  if (!rounds.length) return;
  logicResetPicks(rounds);
  saveBracket();
  renderBracket();
  document.getElementById('champion-banner').classList.remove('visible');
  document.getElementById('champion-name').textContent = '';
}

/* ── Update champion banner from current state ─────────── */
function updateChampionBanner() {
  if (!rounds.length) return;
  const last = rounds[rounds.length - 1][0];
  if (last && last.winner) {
    document.getElementById('champion-name').textContent = last.winner;
    document.getElementById('champion-banner').classList.add('visible');
  } else {
    document.getElementById('champion-banner').classList.remove('visible');
    document.getElementById('champion-name').textContent = '';
  }
}

/* ── Render Bracket ────────────────────────────────────── */
function renderBracket() {
  const container = document.getElementById('bracket-container');
  container.innerHTML = '';

  for (let r = 0; r < rounds.length; r++) {
    const roundDiv = document.createElement('div');
    roundDiv.className = 'round';

    const label = document.createElement('div');
    label.className = 'round-label';
    label.textContent = roundNames[r] || `Round ${r + 1}`;
    roundDiv.appendChild(label);

    const matchupsDiv = document.createElement('div');
    matchupsDiv.className = 'matchups';

    const scale = Math.pow(2, r);
    const baseH = (34 + 4);
    const matchupH = baseH * 2;
    const spacerH = matchupH * scale - matchupH;

    rounds[r].forEach((m, mi) => {
      const mDiv = document.createElement('div');
      mDiv.className = 'matchup';
      mDiv.style.marginTop = mi === 0 ? `${spacerH / 2}px` : `${spacerH}px`;

      mDiv.appendChild(makeSlot(m.top, m, 'top', r, mi));
      mDiv.appendChild(makeSlot(m.bottom, m, 'bottom', r, mi));
      matchupsDiv.appendChild(mDiv);
    });

    roundDiv.appendChild(matchupsDiv);
    container.appendChild(roundDiv);
  }
}

function makeSlot(name, matchup, pos, roundIdx, matchIdx) {
  const div = document.createElement('div');
  div.className = 'team-slot';

  if (!name) {
    div.classList.add('empty');
    div.textContent = '\u2014';
    return div;
  }

  if (roundIdx === 0) {
    const seed = document.createElement('span');
    seed.className = 'seed';
    seed.textContent = pos === 'top' ? matchup.topSeed : matchup.bottomSeed;
    div.appendChild(seed);
  }

  const span = document.createElement('span');
  span.className = 'slot-name';
  span.textContent = name;
  div.appendChild(span);

  if (!name.startsWith('BYE')) {
    const sport = getSport(name);
    const badge = document.createElement('span');
    badge.className = `sport-badge sport-${sport}`;
    badge.textContent = SPORT_LABELS[sport] || 'Other';
    div.appendChild(badge);
  }

  if (matchup.winner === name) div.classList.add('winner');
  else if (matchup.winner && matchup.winner !== name) div.classList.add('loser');

  div.addEventListener('click', () => pickWinner(roundIdx, matchIdx, pos));
  return div;
}

/* ── Pick Winner ───────────────────────────────────────── */
function pickWinner(roundIdx, matchIdx, pos) {
  const result = applyPick(rounds, roundIdx, matchIdx, pos);
  if (!result.changed) return;
  if (result.isFinal && !result.cleared) {
    document.getElementById('champion-name').textContent = result.chosen;
    document.getElementById('champion-banner').classList.add('visible');
  } else if (result.cleared) {
    updateChampionBanner();
  }
  saveBracket();
  renderBracket();
}

/* Silent version for auto-advancing BYEs */
function pickWinnerSilent(roundIdx, matchIdx, pos) {
  const matchup = rounds[roundIdx][matchIdx];
  const chosen = pos === 'top' ? matchup.top : matchup.bottom;
  if (!chosen) return;
  matchup.winner = chosen;
  if (roundIdx < rounds.length - 1) {
    const nextMatchIdx = Math.floor(matchIdx / 2);
    const nextPos = matchIdx % 2 === 0 ? 'top' : 'bottom';
    rounds[roundIdx + 1][nextMatchIdx][nextPos] = chosen;
  }
}

function clearFromRound(roundIdx, matchIdx) {
  logicClearFromRound(rounds, roundIdx, matchIdx);
  if (roundIdx === rounds.length - 1) {
    document.getElementById('champion-banner').classList.remove('visible');
  }
}

/* ── Exports ───────────────────────────────────────────── */
function exportJSON() {
  const names = roundNames.length ? roundNames : rounds.map((_, i) => `Round ${i + 1}`);
  const picks = rounds.map((rnd, ri) => ({
    round: names[ri],
    matchups: rnd.map(m => ({ top: m.top, bottom: m.bottom, winner: m.winner }))
  }));
  const blob = new Blob([JSON.stringify(picks, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'bracket_picks.json'; a.click();
  URL.revokeObjectURL(url);
  toast('Picks exported as JSON!');
}

function exportPDF() {
  const names = roundNames.length ? roundNames : rounds.map((_, i) => `Round ${i + 1}`);
  const picks = rounds.map((rnd, ri) => ({
    round: names[ri],
    matchups: rnd.map(m => ({ top: m.top, bottom: m.bottom, winner: m.winner }))
  }));
  fetch('http://localhost:5000/generate-pdf', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ picks })
  })
  .then(res => { if (!res.ok) throw new Error(); return res.blob(); })
  .then(blob => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'bracket.pdf'; a.click();
    URL.revokeObjectURL(url);
    toast('PDF downloaded!');
  })
  .catch(() => {
    toast('PDF server not running \u2014 opening print dialog...');
    setTimeout(() => window.print(), 600);
  });
}

/* ── Header & bracket toolbar button wiring ────────────── */
document.getElementById('btn-randomize').addEventListener('click', () => {
  if (currentTeams.length < 2) { toast('Generate a bracket first!'); return; }
  initBracket([...athletes.length ? athletes : currentTeams]);
  toast('Bracket shuffled!');
});

document.getElementById('btn-reset-picks').addEventListener('click', () => {
  if (!rounds.length) { toast('Generate a bracket first!'); return; }
  if (confirm('Clear all picks but keep the current matchups?')) {
    resetPicks();
    toast('All picks cleared!');
  }
});

document.getElementById('btn-share').addEventListener('click', shareBracket);
document.getElementById('btn-share-bracket').addEventListener('click', shareBracket);
document.getElementById('btn-export-json').addEventListener('click', exportJSON);
document.getElementById('btn-export-pdf').addEventListener('click', exportPDF);

/* ── Init ──────────────────────────────────────────────── */
(async function boot() {
  // 1. Check for a shared bracket in the URL
  const loadedFromURL = await loadFromURL();
  if (loadedFromURL) {
    renderAthletesList();
    renderBracket();
    updateChampionBanner();
    switchToTab('bracket');
    toast('Shared bracket loaded!');
    return;
  }

  // 2. Load athletes roster
  if (!loadAthletes() || athletes.length === 0) {
    // Fetch from teams.json
    try {
      const res = await fetch('teams.json');
      if (res.ok) {
        const teams = await res.json();
        athletes = teams.filter(t => t && typeof t === 'string');
        saveAthletes();
      }
    } catch { /* ignore */ }
  }
  renderAthletesList();

  // 3. If there's a saved bracket, restore it silently (user can resume via button)
  if (loadBracket()) {
    renderBracket();
    updateChampionBanner();
  }
})();

</script>
</body>
</html>
